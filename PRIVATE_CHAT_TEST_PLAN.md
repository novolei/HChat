# 🧪 私聊功能测试计划

## 📋 测试概述

测试目标：验证 1:1 私聊功能完整性，包括UI、消息发送/接收、会话管理、在线状态等。

## ✅ 测试前准备

### 1. 后端部署

参考 `PRIVATE_CHAT_BACKEND_UPDATE.md` 完成后端更新：

```bash
# 1. SSH 登录 VPS
ssh root@mx.go-lv.com

# 2. 部署私聊后端更新
# （按照部署文档执行）

# 3. 确认服务正常运行
cd ~/hc-stack
docker-compose ps | grep chat-gateway
docker-compose logs -f chat-gateway | grep "私聊消息"
```

### 2. iOS 客户端准备

- [ ] 两台 iOS 设备或模拟器
- [ ] 已安装最新版本的 HChat
- [ ] 两个不同的用户昵称（例如：Alice, Bob）

## 🎯 测试场景

### 场景 1: Tab 导航与基础 UI ⭐⭐⭐

**目标**: 验证新的 Tab 导航结构

#### 步骤:
1. 启动 App
2. 查看底部 Tab 栏

#### 预期结果:
- [ ] 显示 4 个 Tab: "聊天"、"频道"、"通讯录"、"我"
- [ ] 默认选中"聊天" Tab
- [ ] 每个 Tab 图标正确显示
- [ ] 点击每个 Tab 可以正常切换

#### 实际结果:
_（测试时填写）_

---

### 场景 2: 通讯录显示 ⭐⭐⭐

**目标**: 验证通讯录功能

#### 步骤:
1. 点击"通讯录" Tab
2. 观察在线用户列表

#### 预期结果:
- [ ] 显示"在线"分组
- [ ] Alice 和 Bob 都在线时，两者都显示
- [ ] 每个用户显示绿色在线状态点
- [ ] 显示用户头像（自动着色）
- [ ] 显示"在线"状态文字

#### 实际结果:
_（测试时填写）_

---

### 场景 3: 发起私聊（从通讯录） ⭐⭐⭐

**目标**: 验证从通讯录发起私聊

#### 步骤:
1. Alice 登录，进入"通讯录" Tab
2. 看到 Bob 在线
3. 点击 Bob 的用户条目

#### 预期结果:
- [ ] 自动跳转到聊天界面
- [ ] 标题显示 "Bob"
- [ ] 显示输入框
- [ ] 可以正常输入文字

#### 实际结果:
_（测试时填写）_

---

### 场景 4: 发送私聊消息 ⭐⭐⭐

**目标**: 验证私聊消息发送

#### 步骤:
1. Alice 在与 Bob 的聊天界面
2. 输入 "你好，Bob"
3. 点击发送

#### 预期结果:
- [ ] 消息立即显示在聊天界面（本地回显）
- [ ] 消息气泡样式正确（右侧对齐）
- [ ] 显示发送状态（发送中 → 已发送）
- [ ] 服务器日志显示: `💬 私聊消息: Alice -> Bob (channel: dm:Alice:Bob)`
- [ ] 服务器日志显示: `✅ ACK sent for DM xxx`

#### 实际结果:
_（测试时填写）_

---

### 场景 5: 接收私聊消息 ⭐⭐⭐

**目标**: 验证私聊消息接收

#### 步骤:
1. Bob 的设备上查看聊天界面

#### 预期结果:
- [ ] 自动创建与 Alice 的会话
- [ ] 收到消息 "你好，Bob"
- [ ] 消息气泡样式正确（左侧对齐）
- [ ] 显示发送者 "Alice"
- [ ] 显示时间戳
- [ ] 服务器日志显示: `📫 DM delivered to Bob`

#### 实际结果:
_（测试时填写）_

---

### 场景 6: 会话列表更新 ⭐⭐⭐

**目标**: 验证会话列表实时更新

#### 步骤:
1. Bob 返回"聊天" Tab
2. 观察会话列表

#### 预期结果:
- [ ] 显示与 Alice 的会话
- [ ] 会话标题 "Alice"
- [ ] 显示最后消息预览 "你好，Bob"
- [ ] 显示时间（例如 "刚刚"）
- [ ] 显示未读角标 "1"
- [ ] 显示绿色在线状态点

#### 实际结果:
_（测试时填写）_

---

### 场景 7: 回复消息 ⭐⭐

**目标**: 验证消息回复功能

#### 步骤:
1. Bob 点击与 Alice 的会话
2. 输入 "你好，Alice！"
3. 发送

#### 预期结果:
- [ ] Bob 的消息立即显示
- [ ] Alice 收到 Bob 的回复
- [ ] 双方会话列表都更新最后消息
- [ ] 未读角标清零（Bob 这边）

#### 实际结果:
_（测试时填写）_

---

### 场景 8: 使用 /dm 命令 ⭐⭐

**目标**: 验证从频道发起私聊

#### 步骤:
1. Alice 在任意频道（例如 #lobby）
2. 输入 `/dm Bob 测试命令`
3. 发送

#### 预期结果:
- [ ] 自动创建与 Bob 的私聊会话
- [ ] 消息 "测试命令" 发送成功
- [ ] Bob 收到消息
- [ ] 会话列表显示新会话

#### 实际结果:
_（测试时填写）_

---

### 场景 9: 会话管理（置顶/删除/免打扰） ⭐⭐

**目标**: 验证会话管理功能

#### 步骤:
1. Alice 在会话列表
2. 左滑某个会话
3. 点击"置顶"

#### 预期结果:
- [ ] 会话置顶到列表最上方
- [ ] 显示置顶图标（📌）
- [ ] 背景色略有变化

#### 步骤（删除）:
1. 右滑某个会话
2. 点击"删除"

#### 预期结果:
- [ ] 会话从列表中移除
- [ ] 删除后不再显示

#### 步骤（免打扰）:
1. 右滑某个会话
2. 点击"免打扰"

#### 预期结果:
- [ ] 显示免打扰图标（🔕）
- [ ] 未读角标变灰（或不显示）

#### 实际结果:
_（测试时填写）_

---

### 场景 10: 在线状态实时更新 ⭐⭐

**目标**: 验证在线状态实时同步

#### 步骤:
1. Bob 退出 App（或断开连接）
2. Alice 查看通讯录和会话列表

#### 预期结果:
- [ ] 通讯录中 Bob 的状态点变灰
- [ ] 显示"最后在线时间"
- [ ] 会话列表中 Bob 的状态点变灰

#### 步骤（Bob 重新上线）:
1. Bob 重新连接

#### 预期结果:
- [ ] 状态点变回绿色
- [ ] 显示"在线"

#### 实际结果:
_（测试时填写）_

---

### 场景 11: 多条消息连续发送 ⭐

**目标**: 验证消息队列和去重

#### 步骤:
1. Alice 快速连续发送 5 条消息
   - "消息1"
   - "消息2"
   - "消息3"
   - "消息4"
   - "消息5"

#### 预期结果:
- [ ] 所有消息按顺序显示
- [ ] Bob 收到所有 5 条消息
- [ ] 没有重复消息
- [ ] 消息顺序正确

#### 实际结果:
_（测试时填写）_

---

### 场景 12: 消息已读回执 ⭐

**目标**: 验证已读状态

#### 步骤:
1. Alice 发送消息给 Bob
2. Bob 打开聊天界面（阅读消息）

#### 预期结果:
- [ ] Alice 的消息显示"双勾"（已送达）
- [ ] Bob 阅读后，Alice 的消息显示"绿色双勾"（已读）

#### 实际结果:
_（测试时填写）_

---

### 场景 13: 离线消息 ⚠️

**目标**: 验证离线消息处理（当前未实现，期望优雅降级）

#### 步骤:
1. Bob 完全退出 App
2. Alice 发送消息 "离线测试"

#### 预期结果:
- [ ] Alice 可以正常发送
- [ ] 服务器日志显示: `📭 Bob is offline, message queued for later delivery`
- [ ] Bob 重新上线时 **暂时不会** 收到离线消息（功能未实现）
- [ ] 系统不会崩溃或报错

#### 实际结果:
_（测试时填写）_

---

### 场景 14: 附件发送（私聊） ⭐

**目标**: 验证私聊中发送附件

#### 步骤:
1. Alice 在与 Bob 的聊天中
2. 点击附件按钮
3. 选择一张图片
4. 发送

#### 预期结果:
- [ ] 图片上传成功
- [ ] Alice 看到图片预览
- [ ] Bob 收到图片消息
- [ ] 可以点击查看大图

#### 实际结果:
_（测试时填写）_

---

### 场景 15: 搜索聊天 ⭐

**目标**: 验证聊天列表搜索

#### 步骤:
1. Alice 在会话列表
2. 在搜索框输入 "Bob"

#### 预期结果:
- [ ] 显示与 Bob 的会话
- [ ] 其他会话被过滤
- [ ] 清空搜索后恢复所有会话

#### 实际结果:
_（测试时填写）_

---

### 场景 16: 表情反应（私聊） ⭐

**目标**: 验证私聊消息的表情反应

#### 步骤:
1. Alice 长按 Bob 发送的消息
2. 选择一个表情（例如 ❤️）

#### 预期结果:
- [ ] 表情显示在消息下方
- [ ] Bob 看到 Alice 的表情反应
- [ ] 表情徽章显示正确

#### 实际结果:
_（测试时填写）_

---

## 🔍 边界测试

### 边界 1: 昵称冲突
- [ ] 两个用户尝试使用相同昵称
- [ ] 系统是否正确处理

### 边界 2: 长消息
- [ ] 发送超长文本（1000+ 字符）
- [ ] 消息是否正确换行显示

### 边界 3: 特殊字符
- [ ] 发送 Emoji, 特殊符号
- [ ] 消息是否正确显示

### 边界 4: 网络中断
- [ ] 发送消息时断开网络
- [ ] 重连后消息是否自动重发

---

## 📊 性能测试

### 性能 1: 会话列表滚动
- [ ] 创建 20+ 个会话
- [ ] 滚动是否流畅

### 性能 2: 消息列表滚动
- [ ] 单个会话 200+ 条消息
- [ ] 滚动是否流畅

### 性能 3: 多会话切换
- [ ] 快速切换多个会话
- [ ] 是否有延迟或卡顿

---

## 🐛 Bug 追踪

| Bug ID | 场景 | 描述 | 严重程度 | 状态 |
|--------|------|------|----------|------|
| #001   |      |      | High/Med/Low | Open/Fixed |
| #002   |      |      |          |      |

---

## 📝 测试总结

### 通过率

- 核心功能（⭐⭐⭐）: __/16 (___%)
- 重要功能（⭐⭐）: __/__ (___%)
- 次要功能（⭐）: __/__ (___%)
- 总通过率: __/__ (___%)

### 主要问题

1. _（测试后填写）_
2. _（测试后填写）_

### 建议

1. _（测试后填写）_
2. _（测试后填写）_

### 下一步

- [ ] 修复发现的 Bug
- [ ] 实现在线状态广播（后端）
- [ ] 实现离线消息队列
- [ ] 实现好友系统（陌生人限制）
- [ ] 性能优化

---

## 🚀 部署检查清单

### 后端
- [ ] dmHandler.js 已部署
- [ ] handlers/index.js 已更新
- [ ] services/roomManager.js 已更新
- [ ] chat-gateway 服务已重启
- [ ] 查看日志无错误

### 前端
- [ ] 最新代码已编译
- [ ] 无编译错误
- [ ] 无运行时崩溃

---

## 📞 支持

如有问题，请查看：
- GitHub Issues: https://github.com/novolei/HChat/issues
- 后端部署文档: `PRIVATE_CHAT_BACKEND_UPDATE.md`
- 设计文档: `PRIVATE_CHAT_DESIGN_V2.md`

