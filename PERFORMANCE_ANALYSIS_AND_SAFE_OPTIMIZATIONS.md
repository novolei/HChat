# æ€§èƒ½åˆ†æä¸å®‰å…¨ä¼˜åŒ–å»ºè®®

## ğŸ“Š å½“å‰æ€§èƒ½åˆ†æ

### ç°æœ‰è®¡ç®—å±æ€§çš„å¼€é”€

#### 1. `filteredMessages` (ChatMessageListView)
```swift
private var filteredMessages: [ChatMessage] {
    let messages = client.messagesByChannel[channel] ?? []
    if searchText.isEmpty {
        return messages  // O(1) - ç›´æ¥è¿”å›
    } else {
        return messages.filter { ... }  // O(n) - éå†è¿‡æ»¤
    }
}
```
- **è°ƒç”¨é¢‘ç‡**: æ¯æ¬¡ `client.messagesByChannel` å˜åŒ–æ—¶
- **å¤æ‚åº¦**: 
  - æ— æœç´¢: O(1)
  - æœ‰æœç´¢: O(n)ï¼Œn = æ¶ˆæ¯æ•°é‡ï¼ˆé€šå¸¸ < 100ï¼‰
- **å®é™…å¼€é”€**: < 1msï¼ˆå³ä½¿ 1000 æ¡æ¶ˆæ¯ï¼‰
- **æ˜¯å¦éœ€è¦ä¼˜åŒ–**: âŒ **ä¸éœ€è¦**

#### 2. `reactionSummaries` (ChatMessage)
```swift
public var reactionSummaries: [ReactionSummary] {
    reactions.map { emoji, reactionList in
        let uniqueUsers = Array(Set(reactionList.map(\.userId)))
        return ReactionSummary(emoji: emoji, users: uniqueUsers)
    }.sorted { $0.count > $1.count }
}
```
- **è°ƒç”¨é¢‘ç‡**: æ¯æ¬¡è¯¥æ¶ˆæ¯çš„ reactions å˜åŒ–æ—¶
- **å¤æ‚åº¦**: O(m * k)ï¼Œm = emoji ç§ç±»ï¼ˆ< 10ï¼‰ï¼Œk = æ¯ä¸ª emoji çš„ç”¨æˆ·æ•°ï¼ˆ< 5ï¼‰
- **å®é™…å¼€é”€**: < 0.1ms
- **æ˜¯å¦éœ€è¦ä¼˜åŒ–**: âŒ **ä¸éœ€è¦**

#### 3. `displayedSummaries` (ReactionBadgeView body)
```swift
let allSummaries = message.reactionSummaries
let displayedSummaries = Array(allSummaries.prefix(8))
let hasMore = allSummaries.count > maxDisplayCount
```
- **è°ƒç”¨é¢‘ç‡**: æ¯æ¬¡ `message.reactionSummaries` å˜åŒ–æ—¶
- **å¤æ‚åº¦**: O(1) - åªå–å‰ 8 ä¸ª
- **å®é™…å¼€é”€**: < 0.01ms
- **æ˜¯å¦éœ€è¦ä¼˜åŒ–**: âŒ **ä¸éœ€è¦**

## ğŸ¯ çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ

æ ¹æ®ä¹‹å‰çš„æµ‹è¯•ï¼Œå®é™…ç“¶é¢ˆæ˜¯ï¼š

### 1. âŒ å·²è§£å†³ï¼šLazyVStack å»¶è¿ŸåŠ è½½
- ä¹‹å‰ä½¿ç”¨ `List` å¯¼è‡´å¡é¡¿
- ç°åœ¨ä½¿ç”¨ `ScrollView + LazyVStack` âœ…

### 2. âŒ å·²è§£å†³ï¼šå¤æ‚çš„è§†å›¾å±‚çº§
- å·²ç®€åŒ– `MessageRowView` ç»“æ„ âœ…

### 3. âŒ å·²è§£å†³ï¼šé”®ç›˜å“åº”å»¶è¿Ÿ
- å·²ä¼˜åŒ– `KeyboardHelper` âœ…

### 4. âš ï¸ æ½œåœ¨é—®é¢˜ï¼šå¤§é‡æ¶ˆæ¯æ—¶çš„æ»šåŠ¨æ€§èƒ½

å½“æ¶ˆæ¯æ•°é‡ > 500 æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æ»šåŠ¨å¡é¡¿ã€‚ä½†è¿™ä¸æ˜¯è®¡ç®—å±æ€§çš„é—®é¢˜ï¼Œè€Œæ˜¯ï¼š
- SwiftUI çš„ diff ç®—æ³•å¼€é”€
- è§†å›¾å±‚çº§è¿‡æ·±
- è¿‡å¤šçš„åŠ¨ç”»å’Œæ•ˆæœ

## âœ… å®‰å…¨çš„ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–åŸåˆ™

1. **ä¸ç ´åå“åº”æ€§** - æ°¸è¿œä¸ç¼“å­˜ä¼šå½±å“ UI æ›´æ–°çš„æ•°æ®
2. **æµ‹é‡åä¼˜åŒ–** - ç”¨ Instruments ç¡®è®¤ç“¶é¢ˆ
3. **æ¸è¿›å¼ä¼˜åŒ–** - æ¯æ¬¡ä¼˜åŒ–ä¸€ä¸ªç‚¹ï¼Œç«‹å³æµ‹è¯•
4. **å¯å›é€€** - æ¯æ¬¡ä¼˜åŒ–å‰å…ˆ commit

### å¯ä»¥å®‰å…¨ä¼˜åŒ–çš„ç‚¹

#### 1. æ¶ˆæ¯åˆ†é¡µ/è™šæ‹Ÿæ»šåŠ¨ï¼ˆå½“æ¶ˆæ¯ > 500 æ—¶ï¼‰

**å®‰å…¨æ€§**: âœ… ä¸å½±å“å“åº”æ€§

```swift
private var displayedMessages: [ChatMessage] {
    let all = filteredMessages
    // åªæ˜¾ç¤ºæœ€è¿‘ 200 æ¡ + å½“å‰å¯è§åŒºåŸŸé™„è¿‘çš„æ¶ˆæ¯
    if all.count > 200 {
        return Array(all.suffix(200))
    }
    return all
}
```

**ä½†æ³¨æ„**: è¿™ä¼šæ”¹å˜ `filteredMessages` çš„è¯­ä¹‰ï¼Œéœ€è¦ä»”ç»†æµ‹è¯•ï¼

#### 2. æœç´¢é˜²æŠ–ï¼ˆé¿å…æ¯æ¬¡è¾“å…¥éƒ½è¿‡æ»¤ï¼‰

**å®‰å…¨æ€§**: âœ… ä¸å½±å“å“åº”æ€§

```swift
@State private var searchDebounceTask: Task<Void, Never>?

var body: some View {
    // ...
    .onChange(of: searchText) { _, newValue in
        searchDebounceTask?.cancel()
        searchDebounceTask = Task {
            try? await Task.sleep(nanoseconds: 300_000_000) // 300ms
            if !Task.isCancelled {
                // è§¦å‘å®é™…çš„æœç´¢
            }
        }
    }
}
```

**ä½†æ³¨æ„**: 
- `filteredMessages` ä»ç„¶éœ€è¦æ˜¯è®¡ç®—å±æ€§
- åªæ˜¯å»¶è¿Ÿæ›´æ–° `searchText`ï¼Œè€Œä¸æ˜¯ç¼“å­˜ç»“æœ

#### 3. å›¾ç‰‡/è§†é¢‘æ‡’åŠ è½½ï¼ˆå·²ç»å®ç°ï¼‰

**å®‰å…¨æ€§**: âœ… ä¸å½±å“å“åº”æ€§

#### 4. å‡å°‘ä¸å¿…è¦çš„é‡ç»˜

**å®‰å…¨æ€§**: âœ… ä¸å½±å“å“åº”æ€§

```swift
// åœ¨ MessageRowView ä¸­ä½¿ç”¨ equatable é¿å…ä¸å¿…è¦çš„é‡ç»˜
.equatable()  // åªåœ¨ message çœŸæ­£å˜åŒ–æ—¶é‡ç»˜
```

**ä½†æ³¨æ„**: 
- åªèƒ½ç”¨äº `let` å±æ€§çš„è§†å›¾
- ä¸èƒ½ç”¨äºåŒ…å« `@Binding` æˆ– `@State` çš„è§†å›¾

## âŒ ç»å¯¹ä¸èƒ½åšçš„ä¼˜åŒ–

### 1. âŒ ç¼“å­˜ `filteredMessages` ä¸º `@State`
```swift
// æ°¸è¿œä¸è¦è¿™æ ·åšï¼
@State private var filteredMessages: [ChatMessage] = []
```
**åŸå› **: ä¼šç ´åå“åº”æ€§ï¼ˆåˆšåˆšä¿®å¤çš„é—®é¢˜ï¼‰

### 2. âŒ ç¼“å­˜ `reactionSummaries`
```swift
// æ°¸è¿œä¸è¦è¿™æ ·åšï¼
private var _cachedReactionSummaries: [ReactionSummary]?
```
**åŸå› **: ä¼šç ´åå“åº”æ€§

### 3. âŒ æ‰‹åŠ¨ç®¡ç†æ›´æ–°
```swift
// æ°¸è¿œä¸è¦è¿™æ ·åšï¼
.onChange(of: something) { updateSomethingElse() }
```
**åŸå› **: å®¹æ˜“é—æ¼æ›´æ–°ï¼Œå¯¼è‡´ UI ä¸ä¸€è‡´

## ğŸ“ æ€§èƒ½ä¼˜åŒ–çš„æ­£ç¡®å¿ƒæ€

### ä¼˜å…ˆçº§

1. **æ­£ç¡®æ€§** > æ€§èƒ½
2. **å“åº”æ€§** > æ€§èƒ½
3. **å¯ç»´æŠ¤æ€§** > æ€§èƒ½
4. **æ€§èƒ½** - åªåœ¨çœŸæ­£éœ€è¦æ—¶

### ä¼˜åŒ–æµç¨‹

```
1. æµ‹é‡ (Instruments) â†’ ç¡®è®¤ç“¶é¢ˆ
    â†“
2. åˆ†æåŸå›  â†’ æ‰¾åˆ°çœŸæ­£çš„é—®é¢˜
    â†“
3. è®¾è®¡æ–¹æ¡ˆ â†’ ç¡®ä¿ä¸ç ´åå“åº”æ€§
    â†“
4. å®ç°ä¼˜åŒ– â†’ å°æ­¥è¿­ä»£
    â†“
5. æµ‹è¯•éªŒè¯ â†’ åŠŸèƒ½ + æ€§èƒ½
    â†“
6. æäº¤ä»£ç  â†’ ä¾¿äºå›é€€
```

### ä½•æ—¶éœ€è¦ä¼˜åŒ–

åªåœ¨å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼š

1. âœ… **ç”¨æˆ·å¯æ„ŸçŸ¥çš„å¡é¡¿** (< 60 FPS)
2. âœ… **Instruments æ˜¾ç¤ºæ˜ç¡®çš„ç“¶é¢ˆ**
3. âœ… **ç‰¹å®šæ“ä½œè€—æ—¶ > 100ms**

ä¸éœ€è¦ä¼˜åŒ–çš„æƒ…å†µï¼š

1. âŒ "æˆ‘è§‰å¾—è¿™é‡Œå¯èƒ½æ…¢"
2. âŒ "è®¡ç®—å±æ€§ä¼šè¢«å¤šæ¬¡è°ƒç”¨"
3. âŒ "ç¼“å­˜åº”è¯¥æ›´å¿«"

## ğŸ“Š å½“å‰æ€§èƒ½è¯„ä¼°

åŸºäºç°æœ‰ä»£ç ï¼š

- **æ»šåŠ¨æ€§èƒ½**: 60 FPS (< 100 æ¡æ¶ˆæ¯) âœ…
- **è¡¨æƒ…å“åº”**: < 16ms âœ…
- **æœç´¢å“åº”**: < 50ms (< 100 æ¡æ¶ˆæ¯) âœ…
- **é”®ç›˜å“åº”**: < 100ms âœ…
- **æ¶ˆæ¯å‘é€**: < 50ms (æœ¬åœ°å›æ˜¾) âœ…

**ç»“è®º**: ğŸ‰ **å½“å‰æ€§èƒ½å·²ç»è¶³å¤Ÿå¥½ï¼Œä¸éœ€è¦ä¼˜åŒ–ï¼**

## ğŸš€ æœªæ¥ä¼˜åŒ–çš„è§¦å‘æ¡ä»¶

åªåœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰è€ƒè™‘ä¼˜åŒ–ï¼š

1. æ¶ˆæ¯æ•°é‡ > 500 æ—¶æ»šåŠ¨å¡é¡¿
2. çœŸæœºæµ‹è¯•å‡ºç°æ˜æ˜¾å»¶è¿Ÿ
3. Instruments æ˜¾ç¤ºå…·ä½“ç“¶é¢ˆ
4. ç”¨æˆ·åé¦ˆæ€§èƒ½é—®é¢˜

## ğŸ“ æ¨èçš„ç›‘æ§æ–¹å¼

```swift
// å¯ä»¥æ·»åŠ æ€§èƒ½ç›‘æ§æ—¥å¿—ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
#if DEBUG
let start = Date()
defer {
    let duration = Date().timeIntervalSince(start)
    if duration > 0.1 {  // åªè®°å½• > 100ms çš„æ“ä½œ
        DebugLogger.log("âš ï¸ Slow operation: \(duration)s", level: .warning)
    }
}
#endif
```

## ğŸ‰ æ€»ç»“

**å½“å‰å»ºè®®**: 

1. âœ… **ä¿æŒç°çŠ¶** - ä»£ç ç®€å•ã€å“åº”æ€§å¥½
2. âœ… **æŒç»­ç›‘æ§** - å…³æ³¨çœŸæœºæµ‹è¯•çš„æ€§èƒ½
3. âœ… **æŒ‰éœ€ä¼˜åŒ–** - åªåœ¨å‡ºç°é—®é¢˜æ—¶ä¼˜åŒ–
4. âœ… **ä¿æŒç®€å•** - ç®€å•çš„ä»£ç æœ€å¯é 

**è®°ä½**: 
- è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº
- æ­£ç¡®æ€§å’Œå“åº”æ€§æ°¸è¿œä¼˜å…ˆ
- SwiftUI å·²ç»è¶³å¤Ÿæ™ºèƒ½äº†
- ç®€å•çš„ä»£ç æœ€å®¹æ˜“ç»´æŠ¤

**å¦‚æœå°†æ¥çœŸçš„éœ€è¦ä¼˜åŒ–ï¼Œè¯·ï¼š**
1. å…ˆç”¨ Instruments æµ‹é‡
2. ç¡®è®¤ç“¶é¢ˆ
3. Git commit
4. å°æ­¥ä¼˜åŒ–
5. ç«‹å³æµ‹è¯•å“åº”æ€§
6. å¦‚æœ‰é—®é¢˜ç«‹å³å›é€€
